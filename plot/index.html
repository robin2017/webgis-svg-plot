<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SVG标绘</title>
</head>
<body>
<header>
    <h1>SVG标绘</h1>
</header>

<div class="body-wrapper">
    <aside>
        <section class="title">
            <h2>军标列表</h2>
            <button class="cancel">取消标绘</button>
        </section>
        <section class="list">
            <h3 class="item-title">点军标</h3>
            <ul class="item-ul">
                <li>
                    <div class="icon-unit">
                        <img src="icon/point/fly.svg" class="icon-content" alt="飞机">
                        <div>飞机</div>
                    </div>
                </li>
                <li>
                    <div class="icon-unit">
                        <img src="icon/point/people.svg" class="icon-content" alt="飞机">
                        <div>人员</div>
                    </div>
                </li>
                <li>
                    <div class="icon-unit">
                        <img src="icon/point/ship.svg" class="icon-content" alt="飞机">
                        <div>船只</div>
                    </div>
                </li>
            </ul>

            <h3 class="item-title">线面军标</h3>
            <ul class="item-ul">
                <li>
                    <div class="icon-unit">
                        <img src="icon/xm/line.svg" class="icon-content" alt="飞机">
                        <div>线段</div>
                    </div>
                </li>
                <li>
                    <div class="icon-unit">
                        <img src="icon/xm/circle.svg" class="icon-content" alt="飞机">
                        <div>圆</div>
                    </div>
                </li>
                <li>
                    <div class="icon-unit">
                        <img src="icon/xm/rect.svg" class="icon-content" alt="飞机">
                        <div>矩形</div>
                    </div>
                </li>
            </ul>
        </section>
    </aside>
    <main>
        <svg id="plotBoard" width="100%" height="100%">

        </svg>
    </main>
</div>
<div id="svg-lib" style="height:0;"></div>

<script src="svgUtils.js"></script>
<script>
    console.log('完成svg-lib加载');
    loadSvg('#svg-lib', './icon/point/point-lib.svg')
</script>
<script>
    let plotTargetPath = null;
    const plotBoard = document.querySelector('#plotBoard');
    const plotLib = document.querySelector('#svg-lib');
    const translateRegEx = /translate\((.*?),(.*?)\)/;

    //拖拽相关变量
    let dragTarget = null, dragTargetX = null, dragTargetY = null,
        dragTargetClientX = null, dragTargetClientY = null;

    function dragStart(evt) {
        console.log('dragStart')
        dragTarget = getEleNode(evt.target);
        dragTargetClientX = evt.clientX;
        dragTargetClientY = evt.clientY;
        let transform = dragTarget.getAttribute("transform");
        let ret = translateRegEx.exec(transform);
        if (ret !== null) {
            dragTargetX = parseFloat(ret[1]);
            dragTargetY = parseFloat(ret[2]);
            console.log('dragStart:', dragTarget, dragTargetX, dragTargetY, dragTargetClientX, dragTargetClientY)
        }
    }

    function dragMove(evt) {
        if (dragTarget) {
            console.log('dragMove')
            let dx = evt.clientX - dragTargetClientX;
            let dy = evt.clientY - dragTargetClientY;
            let translate = `translate(${dx + dragTargetX},${dy + dragTargetY})`
            dragTarget.setAttribute('transform', translate)
        }
    }

    function dragEnd(evt) {
        console.log('dragEnd')
        dragTarget = null;
    }

    plotBoard.addEventListener('click', function (evt) {
        if (plotTargetPath !== null && evt.target.nodeName === "svg") {
            let x = evt.clientX - evt.target.getBoundingClientRect().left;
            let y = evt.clientY - evt.target.getBoundingClientRect().top;
            // plotPointUse(x, y)
            plotPointClone(x, y)
        } else if (evt.target.nodeName !== "svg" && plotTargetPath === null) {//选中目标，
            console.log('选中目标')
            let target = evt.target;
            if (getEleState(target) === 'edit-inactive') {//状态不可编辑
                let node = getEleNode(target);
                node.setAttribute('class', 'edit-active')
            } else if (getEleState(target) === 'edit-active') {//状态可编辑
                //dragStart(evt)
            }
        } else if (plotTargetPath === null && evt.target.nodeName === "svg") {//全部状态不可编辑
            plotBoard.childNodes.forEach(node => {
                node.setAttribute && node.setAttribute('class', "edit-inactive");
            })
        }
    });

    plotBoard.addEventListener('mousedown', function (evt) {
        if (evt.target.nodeName !== "svg"
            && plotTargetPath === null
            && getEleState(evt.target) === 'edit-active') {
            dragStart(evt)
        }
    })

    plotBoard.addEventListener('mousemove', function (evt) {
        dragMove(evt);
    });
    plotBoard.addEventListener('mouseup', function (evt) {
        dragEnd(evt);
    });

    function getEleState(ele) {//得到元素的编辑状态
        console.log(ele.nodeName)
        let isActive = ele.getAttribute('class');
        if (isActive !== null && isActive.startsWith("edit")) {
            return isActive
        }
        if (ele.nodeName === 'svg') {
            console.error('该元素没有isEdit属性');
            return 'false'
        }
        return getEleState(ele.parentNode)
    }

    function getEleNode(ele) {
        let isActive = ele.getAttribute('class');
        if (isActive !== null && isActive.startsWith("edit")) {
            return ele
        }
        if (ele.nodeName === 'svg') {
            console.error('该元素没有isEdit属性');
            return 'false'
        }
        return getEleNode(ele.parentNode)
    }

    document.querySelector('.body-wrapper > aside .title .cancel')
        .addEventListener('click', function () {
            plotTargetPath = null;
        });
    document.querySelector('.body-wrapper>aside').addEventListener('click', function (evt) {
        if (evt.target.nodeName === 'IMG') {
            let src = evt.target.getAttribute('src');
            let path = src.substring(5, src.length - 4);
            console.log('点击了：', path);
            plotTargetPath = path;
        }
    });

    function plotPointUse(x, y) {
        const newUse = document.createElementNS('http://www.w3.org/2000/svg', 'use');
        newUse.setAttributeNS('http://www.w3.org/1999/xlink', 'href', "#" + plotTargetPath);
        newUse.setAttribute("x", x);
        newUse.setAttribute("y", y);
        plotBoard.appendChild(newUse);
    }

    function plotPointClone(x, y) {
        let target = plotLib.querySelector('#' + plotTargetPath.replace('/', '_'));
        let clone = target.cloneNode(true);
        clone.setAttribute('transform', `translate(${x},${y})`);
        plotBoard.appendChild(clone)
    }
</script>
<style>
    * {
        margin: 0;
        padding: 0;
    }

    html, body {
        height: 100%;
    }

    header {
        height: 100px;
        display: flex;
        align-items: center;
        margin-left: 30px;
    }

    .body-wrapper {
        display: flex;
        height: calc(100% - 140px);
        margin: 20px;
    }

    .body-wrapper > aside {
        width: 400px;
        background-color: #ede;
        border-radius: 10px;
    }

    .body-wrapper > aside .title {
        border-bottom: 2px solid lightcoral;
        height: 56px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-left: 20px;
    }

    .body-wrapper > aside .title .cancel {
        background-color: gray;
        margin-right: 20px;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
    }

    .body-wrapper > aside .list .item-title {
        margin: 10px;
    }

    .body-wrapper > aside .list .item-ul {
        margin-left: 10px;
    }

    .body-wrapper > aside .list .icon-unit {
        display: inline-block;

    }

    .body-wrapper > aside .list .icon-unit img {
        cursor: pointer;
    }

    .body-wrapper > aside .list .icon-unit div {
        display: flex;
        justify-content: center;
    }

    .body-wrapper > aside .list ul li {
        display: inline;
        list-style-type: none;
    }

    .body-wrapper > aside .list .icon-content {
        height: 60px;
        border: 1px solid black;
        border-radius: 4px;
    }

    .body-wrapper > main {
        margin-left: 20px;
        flex: 1;
        background-color: lightgray;
        border-radius: 10px;
    }

    /*操作规范，参见：chap7、svg元素拖动*/

    /*不可编辑状态*/
    #plotBoard .edit-inactive {
        cursor: pointer;
    }

    #plotBoard .edit-inactive .control-group {
        display: none;
    }

    /*可编辑状态*/
    #plotBoard .edit-active {
        cursor: move;
    }

    #plotBoard .edit-active .control-group .control-item-1 {
        cursor: w-resize;
        /*cursor:url("http://ued.taobao.com/blog/wp-content/themes/taobaoued/images/cursor.ico") ,auto;*/
    }

    #plotBoard .edit-active .control-group .control-item-2 {
        cursor: s-resize;
    }

    #plotBoard .edit-active .control-group .control-item-3 {
        cursor: ne-resize;
    }

    #plotBoard .edit-active .control-group .control-item-4 {
        cursor: se-resize;
    }
</style>
</body>

</html>